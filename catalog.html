<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>Title</title>
	<link rel="stylesheet" href="css/main.css">
	<!-- development version, includes helpful console warnings -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
	<script src="./dist/main.js"></script>
</head>
<body>
	<div id="app">
		<cd-root
				api-url="https://raw.githubusercontent.com/GeekBrainsTutorial/online-store-api/master/responses"></cd-root>
	</div>
	<!--script>

        let app = new Vue({
            el: ".box",
            data: {
                cartContent: [], // содержимое корзины
                isVisibleCart: false, // признак видимости корзины
                goodsList: [], // список товаров со страницы
                searchCondition: "", // условие поиска
            },
            mounted() {
                fetch(apiURL + "/catalogData.json")
                        .then(data => data.json())
                        .then(response => {
                            this.goodsList = response;
                        });
            },
            computed: {
                totalCartPrice: function() {
                    let price = 0;

                    this.cartContent.forEach((element) => {
                        let good = this.goodsList.find(good => good.id_product === element.good);
                        price += good.price * element.count;
                    });

                    return price;
                },
                cartItems: function() {
                    let count = 0;

                    this.cartContent.forEach(element => count += element.count);

                    return count;
                },
            },
            methods: {
                priceByID(id) {
                    let idx = this.goodsList.findIndex(element => id === element.id_product);

                    if (-1 !== idx) {
                        return this.goodsList[idx].price;
                    }
                    else console.error("Product price not found by ID " + id);
                },
                productNameByID(id) {
                    let idx = this.goodsList.findIndex(element => id === element.id_product);

                    if (-1 !== idx) {
                        return this.goodsList[idx].product_name;
                    }
                    else console.error("Product name not found by ID " + id);
                },
                addToCart(id) {
                    fetch(apiURL + "/addToBasket.json", /*{
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'omit', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'text/plain'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *client
                body: JSON.stringify({ good: id })*/)
                            .then(data => data.json())
                            .then(reply => {
                                if (reply.result) {
                                    let cartPosition = this.cartContent.findIndex((element) => element.good === id);

                                    if (-1 === cartPosition) {
                                        this.cartContent.push({good: id, count: 1});
                                    } else {
                                        this.cartContent[cartPosition].count += 1;
                                    }
                                }
                            })
                            .catch(err => console.log("Add to basket error! " + err));
                },
                removeFromCart(id) {
                    fetch(apiURL + "/deleteFromBasket.json?id_product="+id, )
                            .then(data => data.json())
                            .then(reply => {
                                if (reply.result) {
                                    this.cartContent = this.cartContent.filter(element => id !== element.good);
                                }
                            })
                            .catch(err => console.log("Remove from basket error! " + err));
                },
                increment(id) {
                    fetch(apiURL + "/addToBasket.json", /*{
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'omit', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'text/plain'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *client
                body: JSON.stringify({ good: id })*/)
                            .then(data => data.json())
                            .then(reply => {
                                if (reply.result) {
                                    let index = this.cartContent.findIndex((element) => id === element.good);
                                    this.cartContent[index].count += 1;
                                }
                            })
                            .catch(err => console.log("Increment basket error! " + err));
                },
                /**
                 * Метод, вычитающий 1 из количества товара. Если товар последний - удалить элемент из массива goodsList
                 * @param {number} id идентификатор товара
                 */
                decrement(id) {
                    fetch(apiURL + "/deleteFromBasket.json?id_product="+id, /*{
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'omit', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'text/plain'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *client
                body: JSON.stringify({ good: id })*/)
                            .then(data => data.json())
                            .then(reply => {
                                if (reply.result) {
                                    let index = this.cartContent.findIndex((element) => id === element.good);
                                    this.cartContent[index].count -= 1;

                                    if (0 === this.cartContent[index].count) {
                                        this.removeFromCart(id);
                                    }
                                }
                            })
                            .catch(err => console.log("Decrement basket error! " + err));
                }
            }
        });
    </script-->
</body>
</html>